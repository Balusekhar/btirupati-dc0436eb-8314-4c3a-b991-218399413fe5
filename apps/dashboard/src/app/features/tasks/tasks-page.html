<div class="d-flex flex-items-start flex-justify-between gap-3 mb-4">
  <div>
    <h1 class="h2 mb-1">Tasks</h1>
    <p class="color-fg-muted m-0">
      Create, edit, and delete tasks. (Next: filters, sorting, drag-and-drop.)
    </p>
  </div>

  <div class="d-flex flex-items-center gap-2">
    <button class="btn btn-primary" type="button" (click)="openCreate()">
      New task
    </button>
    <button class="btn" type="button" (click)="load()" [disabled]="isLoading()">
      Refresh
    </button>
  </div>
</div>

@if (errorMessage()) {
  <div class="flash flash-error mb-3" role="alert">
    {{ errorMessage() }}
  </div>
}

@if (isCreateOpen()) {
  <div class="Box p-4 mb-4">
    <div class="d-flex flex-items-center flex-justify-between mb-3">
      <h2 class="h4 m-0">Create task</h2>
      <button class="btn btn-sm" type="button" (click)="closeCreate()">Close</button>
    </div>

    <form class="d-flex flex-column gap-3" [formGroup]="createForm" (ngSubmit)="submitCreate()">
      <div class="d-flex flex-column flex-md-row gap-3">
        <div class="flex-1">
          <label class="form-label" for="title">Title</label>
          <input id="title" class="form-control input-block" type="text" formControlName="title" />
          @if (createForm.controls.title.touched && createForm.controls.title.invalid) {
            <p class="text-small color-fg-danger mt-1">Title is required.</p>
          }
        </div>
        <div class="flex-1">
          <label class="form-label" for="organizationId">Organization ID</label>
          <input
            id="organizationId"
            class="form-control input-block"
            type="text"
            placeholder="UUID"
            formControlName="organizationId"
          />
          @if (createForm.controls.organizationId.touched && createForm.controls.organizationId.invalid) {
            <p class="text-small color-fg-danger mt-1">Organization ID is required.</p>
          }
        </div>
      </div>

      <div>
        <label class="form-label" for="description">Description (optional)</label>
        <textarea id="description" class="form-control input-block" rows="3" formControlName="description"></textarea>
      </div>

      <div class="d-flex flex-column flex-md-row gap-3">
        <div class="flex-1">
          <label class="form-label" for="status">Status</label>
          <select id="status" class="form-select input-block" formControlName="status">
            @for (s of statusOptions; track s) {
              <option [value]="s">{{ s }}</option>
            }
          </select>
        </div>
        <div class="flex-1">
          <label class="form-label" for="category">Category</label>
          <select id="category" class="form-select input-block" formControlName="category">
            @for (c of categoryOptions; track c) {
              <option [value]="c">{{ c }}</option>
            }
          </select>
        </div>
      </div>

      <div class="d-flex flex-items-center gap-2">
        <button class="btn btn-primary" type="submit" [disabled]="isLoading()">Create</button>
        <button class="btn" type="button" (click)="closeCreate()">Cancel</button>
      </div>
    </form>
  </div>
}

@if (isLoading()) {
  <div class="Box p-4">
    <p class="m-0">Loadingâ€¦</p>
  </div>
} @else {
  @if (tasks().length === 0) {
    <div class="Box p-4">
      <p class="m-0">No tasks yet. Create one to get started.</p>
    </div>
  } @else {
    <div class="d-flex flex-column gap-3">
      @for (task of tasks(); track task.id) {
        <div class="Box p-4">
          <div class="d-flex flex-items-start flex-justify-between gap-3">
            <div class="flex-1">
              <div class="d-flex flex-items-center gap-2 flex-wrap">
                <h3 class="h4 m-0">{{ task.title }}</h3>
                <span class="Label Label--secondary">{{ task.status }}</span>
                <span class="Label Label--accent">{{ task.category }}</span>
                @if (task.dueAt) {
                  <span class="color-fg-muted text-small">Due {{ task.dueAt }}</span>
                }
              </div>

              @if (task.description) {
                <p class="mt-2 mb-0 color-fg-muted">
                  {{ truncate(task.description) }}
                </p>
              }
            </div>

            <div class="d-flex flex-items-center gap-2">
              @if (editingTaskId() === task.id) {
                <button class="btn btn-sm" type="button" (click)="cancelEdit()">
                  Cancel
                </button>
              } @else {
                <button class="btn btn-sm" type="button" (click)="startEdit(task)">
                  Edit
                </button>
                <button class="btn btn-sm btn-danger" type="button" (click)="remove(task)">
                  Delete
                </button>
              }
            </div>
          </div>

          @if (editingTaskId() === task.id) {
            <div class="mt-3">
              <form class="d-flex flex-column gap-3" [formGroup]="editForm" (ngSubmit)="submitEdit(task)">
                <div class="d-flex flex-column flex-md-row gap-3">
                  <div class="flex-1">
                    <label class="form-label" for="editTitle-{{ task.id }}">Title</label>
                    <input
                      id="editTitle-{{ task.id }}"
                      class="form-control input-block"
                      type="text"
                      formControlName="title"
                    />
                  </div>
                  <div class="flex-1">
                    <label class="form-label" for="editStatus-{{ task.id }}">Status</label>
                    <select
                      id="editStatus-{{ task.id }}"
                      class="form-select input-block"
                      formControlName="status"
                    >
                      @for (s of statusOptions; track s) {
                        <option [value]="s">{{ s }}</option>
                      }
                    </select>
                  </div>
                </div>

                <div>
                  <label class="form-label" for="editDesc-{{ task.id }}">Description</label>
                  <textarea
                    id="editDesc-{{ task.id }}"
                    class="form-control input-block"
                    rows="3"
                    formControlName="description"
                  ></textarea>
                </div>

                <div class="d-flex flex-column flex-md-row gap-3">
                  <div class="flex-1">
                    <label class="form-label" for="editDueAt-{{ task.id }}">Due at (optional)</label>
                    <input
                      id="editDueAt-{{ task.id }}"
                      class="form-control input-block"
                      type="datetime-local"
                      formControlName="dueAt"
                    />
                  </div>
                </div>

                <div class="d-flex flex-items-center gap-2">
                  <button class="btn btn-primary btn-sm" type="submit" [disabled]="isLoading()">
                    Save
                  </button>
                  <button class="btn btn-sm" type="button" (click)="cancelEdit()">Cancel</button>
                </div>
              </form>
            </div>
          }
        </div>
      }
    </div>
  }
}
